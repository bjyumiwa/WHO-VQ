<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHO VQ — Beach</title>
  <script src="./web/talk.js"></script>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui,"Noto Sans JP",sans-serif}
    .bg{position:fixed;inset:0;background-image:url('./public/bg/beach_day.jpg');background-size:cover;background-position:center;opacity:1}
    #top{position:fixed;left:0;right:0;top:0;display:flex;gap:8px;justify-content:space-between;padding:8px;z-index:10}
    #top button{border:none;border-radius:10px;padding:6px 10px;background:#fff;color:#111;cursor:pointer}
    #toast{position:fixed;right:8px;top:44px;background:rgba(255,255,255,.92);color:#111;border-radius:10px;padding:8px 12px;z-index:9}
    #gameUi{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);display:flex;gap:8px;z-index:9}
    #gameUi button{border:none;border-radius:10px;padding:8px 14px;background:#fff;color:#111;cursor:pointer}
    #whoaiWrap{position:fixed;left:10vw;bottom:12vh;z-index:6;display:none;transition:left 4s ease, bottom 4s ease}
    #whoai{width:clamp(80px,12vw,140px)}
    #accLayer{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    #bucket{position:fixed;right:2vw;bottom:7vh;z-index:7;width:clamp(74px,14vw,160px);display:none}
    #bucket img{width:100%;display:block}
    #counter{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.9);color:#111;border-radius:999px;padding:4px 8px;font-weight:600}
    #sand{position:fixed;inset:0;z-index:5}
    .shell{position:fixed;z-index:7;width:clamp(48px,6vw,72px);height:clamp(48px,6vw,72px);transform:translate(-50%,-50%);background-size:contain;background-repeat:no-repeat;background-position:center;cursor:grab;opacity:0;transition:opacity .18s, transform .18s}
    .shell.show{opacity:1}
    .shell.drag{transform:translate(-50%,-50%) scale(1.04)}
    .panel{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20}
    .panel.show{display:flex}
    .card{background:#fff;color:#111;border-radius:14px;padding:16px;width:min(92svw,720px)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:12px}
  </style>
</head>
<body>
  <div class="bg"></div>

  <div id="top">
    <div>
      <button id="btnAbout">研究について</button>
      <button id="btnLang">EN</button>
    </div>
    <div>
      <button id="btnNight">夜へ</button>
    </div>
  </div>

  <div id="toast">…</div>

  <div id="whoaiWrap">
    <img id="whoai" src="" alt="">
    <div id="accLayer"></div>
  </div>

  <div id="bucket">
    <img src="./public/bucket.png" alt="bucket">
    <div id="counter">0</div>
  </div>

  <canvas id="sand"></canvas>

  <div id="gameUi">
    <button id="btnCollection">コレクション</button>
    <button id="btnAccessory">アクセサリー</button>
    <button id="btnReset">リセット</button>
  </div>

  <!-- コレクション -->
  <div id="collectionPanel" class="panel" aria-hidden="true">
    <div class="card">
      <h2 id="colTitle">コレクション</h2>
      <div id="collectionSummary" style="margin:6px 0 12px;color:#333"></div>
      <h3 id="colCommonTitle">よくある貝</h3>
      <div id="colCommon" class="grid" style="margin-bottom:12px"></div>
      <h3 id="colRareTitle">レア</h3>
      <div id="colRare" class="grid"></div>
      <div style="text-align:right;margin-top:8px">
        <button id="colClose">閉じる</button>
      </div>
    </div>
  </div>

  <!-- アクセサリー -->
  <div id="accessoryPanel" class="panel" aria-hidden="true">
    <div class="card">
      <h2 id="accTitle">アクセサリー</h2>
      <div id="accList" class="grid"></div>
      <div style="text-align:right;margin-top:8px">
        <button id="accClose">閉じる</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 言語/UI =====
    const L = setLang(getLang());
    $("#btnAbout").textContent = L.about;
    $("#btnLang").textContent  = nextLangLabel(getLang());
    $("#btnNight").textContent = L.toNight;
    $("#btnCollection").textContent = L.collection;
    $("#btnAccessory").textContent  = L.accessory;
    $("#btnReset").textContent      = L.reset;
    $("#colTitle").textContent = L.collection;
    $("#colCommonTitle").textContent = L.collection ? (L.colCommon || "Common Shells") : "Common Shells";
    $("#colRareTitle").textContent   = L.collection ? (L.colRare   || "Rare")         : "Rare";
    $("#toast").textContent = L.beachGuide;

    $("#btnLang").onclick = () => {
      const order = ["ja","en","zh","ko"];
      const next = order[(order.indexOf(getLang())+1)%order.length];
      const LL = setLang(next);
      $("#btnAbout").textContent = LL.about;
      $("#btnLang").textContent  = nextLangLabel(next);
      $("#btnNight").textContent = LL.toNight;
      $("#btnCollection").textContent = LL.collection;
      $("#btnAccessory").textContent  = LL.accessory;
      $("#btnReset").textContent      = LL.reset;
      $("#colTitle").textContent = LL.collection;
      $("#colCommonTitle").textContent = LL.colCommon || "Common Shells";
      $("#colRareTitle").textContent   = LL.colRare || "Rare";
      $("#toast").textContent = LL.beachGuide;
    };
    $("#btnAbout").onclick = () => location.href="./about.html";
    $("#btnNight").onclick = () => { store.set("whoai.lastScene","night"); location.href="./night.html"; };

    // ===== キャラ表示 =====
    const whoaiSrc = store.get("whoai.char", null);
    if (whoaiSrc) {
      $("#whoaiWrap").style.display = "block";
      $("#whoai").src = whoaiSrc;
      setInterval(()=>{
        $("#whoaiWrap").style.left   = (8 + Math.random()*72) + "vw";
        $("#whoaiWrap").style.bottom = (10+ Math.random()*60) + "vh";
      }, 5000);
    }

    // ===== 砂 =====
    const sand = $("#sand");
    const ctx = sand.getContext("2d",{willReadFrequently:true});
    function resizeSand(){
      sand.width = innerWidth; sand.height = innerHeight;
      const g = ctx.createLinearGradient(0,0,0,sand.height);
      g.addColorStop(0,"#e7d9b7"); g.addColorStop(1,"#c8b68f");
      ctx.fillStyle=g; ctx.fillRect(0,0,sand.width,sand.height);
      ctx.globalAlpha=.12;
      for(let i=0;i<800;i++){
        const x=Math.random()*sand.width, y=Math.random()*sand.height;
        ctx.fillStyle=(i%3===0)?"#bfae82":"#d2c29a";
        ctx.beginPath(); ctx.arc(x,y,Math.random()*1.2+.2,0,Math.PI*2); ctx.fill();
      }
      ctx.globalAlpha=1;
    }
    resizeSand();
    addEventListener("resize",()=>resizeSand());

    const bucket = $("#bucket"); const counter = $("#counter");
    bucket.style.display="block";

    // ===== 貝 =====
    const COMMON = ['./public/items/asari1.png','./public/items/asari2.png','./public/items/asari3.png'];
    const RARE   = ['./public/items/aurora_shell.png','./public/items/rare_pearl.png','./public/items/rare_rainbow.png'];
    let count = store.get("whoai.count",0)||0; counter.textContent = count;
    let spawnedTotal = store.get("whoai.spawned",0)||0;
    const shells = [];
    const MAX_SHELLS=8, TOTAL_SPAWN_LIMIT=20, MIN_DIST=90, SPAWN_P=.18;
    function tooClose(x,y){ return shells.some(s=>Math.hypot(s.x-x,s.y-y)<MIN_DIST); }
    function avoidBucket(x,y){
      const b=bucket.getBoundingClientRect(); const cx=(b.left+b.right)/2, cy=(b.top+b.bottom)/2;
      return Math.hypot(cx-x,cy-y)<120;
    }
    const BRUSH=30;
    function brushAt(x,y){
      ctx.globalCompositeOperation="destination-out";
      ctx.globalAlpha=.35;
      ctx.beginPath(); ctx.arc(x,y,BRUSH,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=1; ctx.globalCompositeOperation="source-over";
      maybeSpawnNear(x,y);
    }
    sand.addEventListener("pointerdown",e=>brushAt(e.clientX,e.clientY),{passive:false});
    sand.addEventListener("pointermove",e=>{ if(e.buttons) brushAt(e.clientX,e.clientY); },{passive:false});

    function maybeSpawnNear(x,y){
      if(shells.length>=MAX_SHELLS || spawnedTotal>=TOTAL_SPAWN_LIMIT || Math.random()>SPAWN_P) return;
      let px=x+(Math.random()*2-1)*90, py=y+(Math.random()*2-1)*90;
      px=Math.max(60,Math.min(innerWidth-60,px));
      py=Math.max(100,Math.min(innerHeight-100,py));
      if(tooClose(px,py)||avoidBucket(px,py)) return;
      const rare=Math.random()<.18;
      const pool=rare?RARE:COMMON;
      const src=pool[Math.floor(Math.random()*pool.length)];
      const el=document.createElement("div");
      el.className="shell";
      el.style.left=px+"px"; el.style.top=py+"px";
      el.style.backgroundImage=`url(${src})`;
      document.body.appendChild(el);
      requestAnimationFrame(()=>el.classList.add("show"));
      enableShellDrag(el,src);
      shells.push({el,x:px,y:py,src});
      spawnedTotal++; store.set("whoai.spawned",spawnedTotal);
    }

    function enableShellDrag(el,src){
      let pid=null, dx=0, dy=0;
      el.addEventListener("pointerdown",e=>{
        e.preventDefault(); pid=e.pointerId; el.setPointerCapture(pid);
        dx = e.clientX - parseFloat(el.style.left);
        dy = e.clientY - parseFloat(el.style.top);
        el.classList.add("drag");
      },{passive:false});
      el.addEventListener("pointermove",e=>{
        if(e.pointerId!==pid) return; e.preventDefault();
        el.style.left = (e.clientX - dx) + "px";
        el.style.top  = (e.clientY - dy) + "px";
      },{passive:false});
      function finish(e){
        if(e.pointerId!==pid) return; e.preventDefault();
        el.classList.remove("drag"); el.releasePointerCapture(pid); pid=null;
        const b=bucket.getBoundingClientRect(); const s=el.getBoundingClientRect();
        const hit=!(s.right<b.left||s.left>b.right||s.bottom<b.top||s.top>b.bottom);
        if(hit){
          el.remove();
          const i=shells.findIndex(o=>o.el===el); if(i>-1) shells.splice(i,1);
          count++; counter.textContent=count; store.set("whoai.count",count);
          // コレクション更新
          const key = src.split('/').pop().replace('.png','');
          const c = store.get("whoai.collection",{}); c[key]=(c[key]||0)+1; store.set("whoai.collection",c);
          // 20個で夜に誘導
          if(count>=20){ alert("20個集まったよ！ 夜の海で話そうか？"); store.set("whoai.lastScene","night"); location.href="./night.html"; }
        }
      }
      el.addEventListener("pointerup",finish,{passive:false});
      el.addEventListener("pointercancel",finish,{passive:false});
    }

    // ===== コレクション＆アクセサリーUI（簡易） =====
    const collectionPanel = $("#collectionPanel");
    const colCommon = $("#colCommon"); const colRare = $("#colRare");
    const collectionSummary = $("#collectionSummary");
    const ALL_ITEMS=[...COMMON,...RARE].map(src=>({key:src.split('/').pop().replace('.png',''),src}));
    function openPanel(p){ p.classList.add("show"); p.setAttribute("aria-hidden","false"); }
    function closePanel(p){ p.classList.remove("show"); p.setAttribute("aria-hidden","true"); }
    $("#colClose").onclick = ()=>closePanel(collectionPanel);
    $("#accClose").onclick = ()=>closePanel($("#accessoryPanel"));

    function buildCollectionGrid(){
      const make=(src)=>{const key=src.split('/').pop().replace('.png',''); const slot=document.createElement('div');
        slot.className="slot"; slot.innerHTML = `
          <div class="thumb" style="background-image:url(${src});width:80px;height:80px;background-size:contain;background-repeat:no-repeat;background-position:center;margin:auto"></div>
          <div class="name" style="text-align:center">${key}</div>
          <div class="count" style="text-align:center">×<span data-key="${key}">0</span></div>`;
        return slot;
      };
      colCommon.innerHTML=''; COMMON.forEach(s=>colCommon.appendChild(make(s)));
      colRare.innerHTML='';   RARE.forEach(s=>colRare.appendChild(make(s)));
      colCommon.dataset.ready='1'; colRare.dataset.ready='1';
    }
    function refreshCollection(){
      const col = store.get("whoai.collection",{});
      const totalKinds=ALL_ITEMS.length;
      const ownedKinds=ALL_ITEMS.filter(x=>(col[x.key]||0)>0).length;
      const total=Object.values(col).reduce((a,b)=>a+b,0);
      collectionSummary.textContent = `入手種: ${ownedKinds}/${totalKinds}　総数: ${total}　コンプ率: ${Math.round(ownedKinds/totalKinds*100)}%`;
      $$("#collectionPanel .count span").forEach(span=>{
        const key=span.getAttribute("data-key"); span.textContent = col[key]||0;
      });
    }
    $("#btnCollection").onclick = ()=>{
      if(!colCommon.dataset.ready) buildCollectionGrid();
      refreshCollection(); openPanel(collectionPanel);
    };

    // アクセサリー（解放ラインだけ用意）
    const ACCESSORIES=[
      {key:'straw_hat', name:'麦わら帽子',   src:'./public/accessories/straw_hat.png',    unlockAt:3},
      {key:'knit_hat',  name:'毛糸の帽子',   src:'./public/accessories/knit_hat.png',     unlockAt:6},
      {key:'sunglasses',name:'サングラス',   src:'./public/accessories/sunglasses.png',   unlockAt:10},
      {key:'ribbon_yellow',name:'黄色いリボン',src:'./public/accessories/ribbon_yellow.png',unlockAt:15},
      {key:'star_yellow',  name:'黄色のスター', src:'./public/accessories/star_yellow.png',  unlockAt:20},
    ];
    function totalCollected(){
      const col=store.get("whoai.collection",{});
      return Object.values(col).reduce((a,b)=>a+b,0);
    }
    function getActiveAcc(){ return new Set(store.get("whoai.accessories",[])); }
    function setActiveAcc(s){ store.set("whoai.accessories", Array.from(s)); }
    function addAccImg(a){
      const wrap = $("#accLayer");
      const exist = wrap.querySelector(`[data-key="${a.key}"]`);
      if (exist) exist.remove();
      const img = document.createElement("img");
      img.src=a.src; img.alt=a.name; img.dataset.key=a.key;
      img.style.position="absolute"; img.style.left="50%"; img.style.top="12%";
      img.style.transform="translate(-50%,-50%)";
      img.style.width="60%";
      wrap.appendChild(img);
    }
    function removeAccImg(key){
      const el = $("#accLayer").querySelector(`[data-key="${key}"]`); if(el) el.remove();
    }
    function restoreAccessories(){
      const active=getActiveAcc();
      ACCESSORIES.forEach(a=>{ if(active.has(a.key)) addAccImg(a); });
    }
    restoreAccessories();

    $("#btnAccessory").onclick = ()=>{
      const panel = $("#accessoryPanel");
      const list  = $("#accList");
      if(!list.dataset.ready){
        ACCESSORIES.forEach(a=>{
          const div=document.createElement("div");
          div.className="accChoice";
          div.innerHTML=`
            <div style="background:#f8f8f8;border-radius:12px;padding:8px;text-align:center">
              <img src="${a.src}" alt="${a.name}" style="width:80px;height:auto;display:block;margin:0 auto 6px">
              <div style="font-weight:700">${a.name}</div>
              <div class="hint" style="font-size:12px;color:#666">タップで装着/解除</div>
              <input type="checkbox" style="display:block;margin:8px auto 0">
            </div>`;
          const cb = div.querySelector("input");
          cb.addEventListener("change",()=>{
            const tot = totalCollected();
            if(tot<a.unlockAt){ alert(`あと ${a.unlockAt - tot} 個で解放`); cb.checked = false; return; }
            const set = getActiveAcc();
            if(cb.checked){ set.add(a.key); addAccImg(a); } else { set.delete(a.key); removeAccImg(a.key); }
            setActiveAcc(set);
          });
          div.addEventListener("click",e=>{
            if(e.target.tagName!=="INPUT"){ cb.checked=!cb.checked; cb.dispatchEvent(new Event("change")); }
          });
          list.appendChild(div);
        });
        list.dataset.ready="1";
      }
      // 解放状態反映
      const tot=totalCollected(); const active=getActiveAcc();
      $$(".accChoice").forEach(div=>{
        const name = div.querySelector("div>div:nth-child(2)").textContent;
        const a = ACCESSORIES.find(x=>x.name===name);
        const cb = div.querySelector("input"); const hint = div.querySelector(".hint");
        const locked = tot < a.unlockAt;
        div.style.opacity = locked ? .5 : 1;
        cb.disabled = locked;
        hint.textContent = locked ? `あと ${a.unlockAt - tot} 個で解放` : "タップで装着/解除";
        cb.checked = active.has(a.key);
      });

      openPanel(panel);
    };

    // リセット
    $("#btnReset").onclick = ()=>{
      store.set("whoai.count",0); count=0; counter.textContent=0;
      store.set("whoai.spawned",0); spawnedTotal=0;
      store.set("whoai.collection",{});
      location.reload();
    };
  </script>
</body>
</html>
