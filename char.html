<!DOCTYPE html>
<html lang="ja" data-lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHO VQ — キャラ選択</title>
  <meta name="description" content="WHO VQ のキャラクター選択" />
  <style>
    :root{
      --glass: rgba(255,255,255,.92);
      --glass-soft: rgba(255,255,255,.85);
      --text: #111;
    }
    html,body{
      margin:0;height:100%;overflow:auto;background:#000;color:#fff;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans JP", Segoe UI, Roboto, sans-serif;
    }
    /* 背景 */
    .bg{
      position:fixed; inset:0; z-index:0;
      background-image:url("./public/bg/sunrise.jpg");
      background-repeat:no-repeat; background-size:cover;
      background-position:center 38%;
      filter: saturate(105%);
    }
    @media (max-width: 768px){
      .bg{ background-position:center 50%; }
    }
    .veil{
      position:fixed; inset:0; z-index:1;
      background: radial-gradient(1400px 700px at 50% 12%, rgba(0,0,0,.12), rgba(0,0,0,.50) 60%, rgba(0,0,0,.7));
    }

    /* Topbar */
    #topbar{
      position:sticky; top:0; z-index:5;
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; gap:10px;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
      backdrop-filter: blur(2px);
    }
    .btn{
      border:none; border-radius:12px; padding:8px 14px; cursor:pointer;
      font-weight:700; background:var(--glass); color:var(--text);
      box-shadow:0 2px 10px rgba(0,0,0,.12);
    }
    .btn[disabled]{opacity:.5; cursor:not-allowed;}

    /* メイン */
    main{
      position:relative; z-index:4;
      max-width:min(1100px, 94vw);
      margin: 60px auto 48px;
    }
    .card{
      background: var(--glass-soft);
      color: var(--text);
      border-radius:16px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(4px);
    }
    h1{ margin:0 0 8px; font-size: clamp(22px, 5.2vw, 34px); }
    p{ line-height:1.7; margin:.3rem 0 1rem; }

    .grid{
      display:grid; gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      margin-top:12px;
    }
    .choice{
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px 10px 12px;
      background:#fff;
      color:#111;
      text-align:center;
      cursor:pointer;
      transition: transform .12s, box-shadow .12s, border-color .12s;
      box-shadow:0 4px 14px rgba(0,0,0,.08);
      user-select:none;
    }
    .choice:hover{ transform: translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.12); }
    .choice.selected{ border-color:#4cafef; box-shadow:0 0 0 3px rgba(76,175,239,.25); }
    .choice img{ width:92px; height:auto; display:block; margin:0 auto 8px; image-rendering:auto; }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:14px;
    }
    .muted{ opacity:.85; font-size:13px; }
    .footer{
      text-align:center; margin:22px 0 10px; opacity:.8;
      text-shadow:0 1px 6px rgba(0,0,0,.5);
    }

    /* プレビュー */
    .preview{
      display:flex; align-items:center; gap:12px; margin-top:6px;
      background: rgba(255,255,255,.65); border-radius:12px; padding:8px 10px;
    }
    .preview img{ width:64px; height:auto; }
    .preview .name{ font-weight:700; }
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>
  <div class="veil" aria-hidden="true"></div>

  <!-- Topbar -->
  <div id="topbar">
    <div class="left">
      <button id="btnHome" class="btn">戻る</button>
    </div>
    <div class="right">
      <button id="btnLang" class="btn" title="言語を切り替え">EN</button>
    </div>
  </div>

  <main role="main" aria-labelledby="title">
    <div class="card">
      <h1 id="title">キャラを選んでね</h1>
      <p id="lead" class="muted">好きな見た目を選択。あとから変更もできます。</p>

      <div id="preview" class="preview" style="display:none;">
        <img id="prevImg" alt="">
        <div>
          <div id="prevLabel" class="name">—</div>
          <div id="prevHint" class="muted">このキャラで始めます</div>
        </div>
      </div>

      <div id="grid" class="grid" aria-label="characters"></div>

      <div class="actions">
        <button id="btnRandom" class="btn">ランダム</button>
        <span class="muted" style="flex:1"></span>
        <button id="btnContinue" class="btn" title="保存済みで続きから">続きから</button>
        <button id="btnStart" class="btn">このキャラで開始</button>
      </div>
    </div>

    <div class="footer">© WHO VQ</div>
  </main>

  <script>
  /* ===== 多言語 ===== */
  const I18N = {
    ja:{
      back:'戻る', langNext:'EN',
      title:'キャラを選んでね',
      lead:'好きな見た目を選択。あとから変更もできます。',
      random:'ランダム',
      continue:'続きから',
      start:'このキャラで開始',
      previewHint:'このキャラで始めます',
    },
    en:{
      back:'Back', langNext:'中文',
      title:'Choose your character',
      lead:'Pick your look. You can change it later.',
      random:'Random',
      continue:'Continue',
      start:'Start with this character',
      previewHint:'Start with this character',
    },
    zh:{
      back:'返回', langNext:'한국어',
      title:'选择角色',
      lead:'选择喜欢的外观，之后也可以更改。',
      random:'随机',
      continue:'继续',
      start:'用此角色开始',
      previewHint:'将以此角色开始',
    },
    ko:{
      back:'뒤로', langNext:'日本語',
      title:'캐릭터를 선택하세요',
      lead:'마음에 드는 외형을 고르세요. 나중에 변경할 수 있어요.',
      random:'랜덤',
      continue:'계속',
      start:'이 캐릭터로 시작',
      previewHint:'이 캐릭터로 시작합니다',
    }
  };
  const LANG_ORDER = ['ja','en','zh','ko'];
  const LANG_LABEL  = {ja:'日本語', en:'EN', zh:'中文', ko:'한국어'};
  const getLang = () => localStorage.getItem('who_vq.lang') || 'ja';

  function setLang(lang){
    const L = I18N[lang] || I18N.ja;
    document.documentElement.setAttribute('lang',lang);
    localStorage.setItem('who_vq.lang', lang);

    document.getElementById('btnHome').textContent = L.back;
    document.getElementById('title').textContent   = L.title;
    document.getElementById('lead').textContent    = L.lead;
    document.getElementById('btnRandom').textContent  = L.random;
    document.getElementById('btnContinue').textContent= L.continue;
    document.getElementById('btnStart').textContent   = L.start;
    document.getElementById('prevHint').textContent   = L.previewHint;

    const idx = LANG_ORDER.indexOf(lang);
    const next= LANG_ORDER[(idx+1)%LANG_ORDER.length];
    const btnLang = document.getElementById('btnLang');
    btnLang.textContent = LANG_LABEL[next];
    btnLang.title = `言語を${LANG_LABEL[next]}に切り替え`;
  }
  function toggleLang(){
    const cur = getLang();
    const idx = LANG_ORDER.indexOf(cur);
    const next= LANG_ORDER[(idx+1)%LANG_ORDER.length];
    setLang(next);
  }

  /* ===== データ・定数 ===== */
  // キャラ画像（public/assets/stage1 に配置）
  const CHAR_LIST = [
    'blue_closed.png','green_open.png','orange_closed.png','pink_closed.png','purple_closed.png',
    'tane_green.png','tane_pink.png','tane_purple.png','tane_blue.png'
  ].map(n => `./public/assets/stage1/${n}`);

  // 保存キー
  const KEY_CHAR = 'who_vq.char';
  const KEY_LAST = 'who_vq.lastScene';

  /* ===== UI 要素 ===== */
  const grid = document.getElementById('grid');
  const btnHome = document.getElementById('btnHome');
  const btnLang = document.getElementById('btnLang');
  const btnRandom = document.getElementById('btnRandom');
  const btnStart  = document.getElementById('btnStart');
  const btnContinue = document.getElementById('btnContinue');
  const preview = document.getElementById('preview');
  const prevImg = document.getElementById('prevImg');
  const prevLabel = document.getElementById('prevLabel');

  let selected = null;

  /* ===== 画面構築 ===== */
  function buildGrid(){
    grid.innerHTML = '';
    CHAR_LIST.forEach(src=>{
      const base = src.split('/').pop().replace('.png','');
      const d = document.createElement('div');
      d.className = 'choice';
      d.innerHTML = `<img src="${src}" alt="${base}"><div>${base}</div>`;
      d.onclick = ()=> selectChar(src, d);
      grid.appendChild(d);
    });
  }

  function selectChar(src, el){
    selected = src;
    // 選択表示
    [...grid.children].forEach(ch => ch.classList.remove('selected'));
    if(el) el.classList.add('selected');

    // プレビュー
    preview.style.display = 'flex';
    prevImg.src = src;
    prevImg.alt = src.split('/').pop();
    prevLabel.textContent = src.split('/').pop().replace('.png','');
  }

  function startWithSelected(){
    const pick = selected || randomChar();
    localStorage.setItem(KEY_CHAR, JSON.stringify(pick));
    // 初回はシーンを beach に
    localStorage.setItem(KEY_LAST, JSON.stringify('beach'));
    location.href = './beach.html';
  }

  function randomChar(){
    const i = Math.floor(Math.random() * CHAR_LIST.length);
    return CHAR_LIST[i];
  }

  /* ===== 初期化 ===== */
  function init(){
    setLang(getLang());
    btnHome.onclick = ()=> location.href = './index.html';
    btnLang.onclick = toggleLang;
    btnRandom.onclick = ()=> selectChar(randomChar(), null);
    btnStart.onclick  = startWithSelected;

    // 続きから（保存がなければ無効）
    const hasSave = !!JSON.parse(localStorage.getItem(KEY_CHAR) || 'null');
    btnContinue.disabled = !hasSave;
    btnContinue.onclick = ()=>{
      const last = JSON.parse(localStorage.getItem(KEY_LAST) || '"beach"');
      location.href = last === 'night' ? './beach.html' : './beach.html';
    };

    buildGrid();

    // 既存選択があればプレビュー
    const saved = JSON.parse(localStorage.getItem(KEY_CHAR) || 'null');
    if(saved){
      // グリッド内の一致要素を探す
      const child = [...grid.children].find(ch=>{
        const img = ch.querySelector('img'); return img && img.getAttribute('src') === saved;
      });
      selectChar(saved, child || null);
    }
  }
  init();
  </script>
</body>
</html>
