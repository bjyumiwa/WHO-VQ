<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHO VQ — Start</title>
  <!-- 画像は読み込めなくてもOK。JS側でフォールバックします -->
  <link rel="stylesheet" href="web/style.css">
  <script defer src="web/talk.js"></script>
  <style>
    /* 画像が無い時のフェイルセーフ背景 */
    .bg.fallback{
      background: radial-gradient(ellipse at 30% 20%, rgba(255,255,255,.12), rgba(0,0,0,0)) ,
                  linear-gradient(180deg, #02111f, #033a52 40%, #052a31 100%);
      filter:none; opacity:1;
    }
  </style>
</head>
<body data-page="index">
  <div class="bg" id="bg"></div>
  <header class="topbar">
    <!-- ロゴも onerror で非表示フォールバック -->
    <img src="public/assets/logo_who_vq.png" alt="WHO VQ" class="logo"
         onerror="this.style.display='none'"/>
    <div class="right">
      <select id="langSelect" aria-label="language"></select>
    </div>
  </header>

  <main class="center">
    <h1>WHO VQ</h1>
    <p class="subtitle">あなたのお世話が、誰かの世界に</p>
    <div class="buttons">
      <button class="btn primary" id="btnStart" data-i18n="start">スタート</button>
      <button class="btn" id="btnContinue" data-i18n="continue">続きから</button>
      <button class="btn ghost" id="btnAbout" data-i18n="about">研究について</button>
    </div>
  </main>

  <script>
   /********** i18n **********/
const translations = {
  ja:{ title:'WHO VQ',subtitle:'あなたのお世話が、誰かの世界に',
      start:'スタート',continue:'続きから',about:'研究について',
      phase_prefix:'背景：',sunrise:'朝日',day:'昼',night:'夜',
      resume_saved:'前回のページは保存済みです。「続きから」で再開できます。',
      resume_none:'前回のページは未保存です。「スタート」から始められます。',
      head_suffix:'— スタート' },
  en:{ title:'WHO VQ',subtitle:"Your care becomes someone's world",
      start:'Start',continue:'Continue',about:'About',
      phase_prefix:'BG: ',sunrise:'Sunrise',day:'Day',night:'Night',
      resume_saved:'Your last page is saved. Tap “Continue” to resume.',
      resume_none:'No previous session. Tap “Start” to begin.',
      head_suffix:'— Start' },
  zh:{ title:'WHO VQ',subtitle:'您的关怀，成就他人的世界',
      start:'开始',continue:'继续',about:'关于研究',
      phase_prefix:'背景：',sunrise:'日出',day:'白天',night:'夜晚',
      resume_saved:'已保存上次页面，点击“继续”恢复。',
      resume_none:'没有上次记录，点击“开始”进入。',
      head_suffix:'— 开始' },
  ko:{ title:'WHO VQ',subtitle:'당신의 돌봄이 누군가의 세상이 됩니다',
      start:'시작',continue:'계속하기',about:'연구 소개',
      phase_prefix:'배경: ',sunrise:'아침',day:'낮',night:'밤',
      resume_saved:'이전 페이지가 저장되어 있습니다. “계속하기”를 눌러 재개하세요.',
      resume_none:'이전 기록이 없습니다. “시작”을 눌러 시작하세요.',
      head_suffix:'— 시작' }
};
let currentLang = localStorage.getItem('who_language') || 'ja';

function updateTexts(){
  const t = translations[currentLang] || translations.ja;

  // 本文ラベル
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n'); if(t[key]) el.textContent = t[key];
  });

  // タイトル
  document.title = `${t.title} ${t.head_suffix}`;
  document.documentElement.lang = currentLang;

  // 背景ラベル
  if(window.__currentPhase){
    const phaseLabel = document.getElementById('phaseLabel');
    phaseLabel.textContent = `${t.phase_prefix}${t[window.__currentPhase]}`;
  }

  // 再開メモ
  const last = localStorage.getItem('who_lastPage');
  document.getElementById('resumeNote').textContent = last ? t.resume_saved : t.resume_none;
}

function initLang(){
  const sel = document.getElementById('langSelect');
  sel.value = currentLang;
  sel.addEventListener('change',e=>{
    currentLang = e.target.value;
    localStorage.setItem('who_language', currentLang);
    updateTexts(); // 言語切り替え時に背景ラベルも強制更新
  });
  updateTexts();
}

/********** 背景 **********/
function setBackground(phase){
  const path = BG[phase];
  const img = new Image();
  img.onload = ()=>{
    bg.style.backgroundImage = `url(${path})`;
    bg.classList.add('show'); bg.classList.remove('fallback');
    window.__currentPhase = phase;  // ← ここで必ず記録
    updateTexts();                  // ← 記録直後に再描画
    localStorage.setItem('who_timePhase', phase);
  };
  img.onerror = ()=>{
    console.warn('背景読み込み失敗:', path);
    bg.classList.add('show');
    window.__currentPhase = phase;
    updateTexts();
  };
  img.src = path + '?v=' + Date.now();
}

  </script>
</body>
</html>
