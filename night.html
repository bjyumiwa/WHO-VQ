
<!DOCTYPE html>
<html lang="ja" data-lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>WHO VQ â€” å¤œã®ä¼šè©±</title>
  <meta name="description" content="WHO VQ ã®å¤œä¼šè©±ã‚·ãƒ¼ãƒ³" />
  <style>
    html,body{
      margin:0;height:100%;overflow:hidden;background:#000;color:#fff;
      font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,sans-serif
    }
    /* èƒŒæ™¯ */
    .bg{position:fixed; inset:0; background-size:cover; background-position:center; opacity:0; transition:opacity .6s}
    .bg.show{opacity:1}
    #bg-night{ background-image:url("./public/bg/night_beach.jpg"); }

    /* Topbar */
    #topbar{
      position:fixed;left:0;right:0;top:0;z-index:40;display:flex;justify-content:space-between;align-items:center;
      padding:8px 10px;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0))
    }
    #topbar .left,#topbar .right{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border:none;border-radius:12px;background:rgba(255,255,255,.92);color:#111;cursor:pointer;font-weight:700}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);font-size:12px}

    /* ã‚³ãƒ³ãƒ†ãƒŠ */
    #wrap{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:70px 10px 10px}
    #panel{
      width:min(96svw,720px); max-height:88vh; display:flex; flex-direction:column; gap:10px;
      background:rgba(255,255,255,.75); color:#111; border-radius:16px; backdrop-filter:blur(6px); padding:12px
    }
    #headerRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    #personaRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    #personaRow label{display:inline-flex; align-items:center; gap:4px; background:#fff; border:1px solid #ddd; padding:6px 8px; border-radius:10px; cursor:pointer}
    #nameRow{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    #nameInput{flex:1; min-width:180px; padding:8px 10px; border-radius:10px; border:1px solid #ccc}
    #nameSave{padding:8px 10px; border:none; border-radius:10px; background:#4cafef; color:#fff; cursor:pointer}

    /* ãƒãƒ£ãƒƒãƒˆ */
    #chatLog{flex:1; background:rgba(242,242,242,.45); padding:10px; border-radius:12px; overflow:auto}
    .msg{margin:6px 0; padding:8px 12px; border-radius:16px; max-width:70%}
    .msg.me{background:rgba(174,225,255,.85); color:#002; margin-left:auto}
    .msg.ai{background:rgba(255,255,255,.9); color:#000; margin-right:auto}
    #chatCtrl{display:flex; gap:6px}
    #chatInput{flex:1; padding:10px; border-radius:12px; border:1px solid #ccc}
    #chatSend{padding:10px 14px; border:none; border-radius:12px; background:#4cafef; color:#fff; cursor:pointer}

    /* whoaiï¼ˆå³ä¸‹, å¤œã¯æ§ãˆã‚ã«ï¼‰ */
    #whoaiWrap{position:fixed; right:3vw; bottom:8vh; z-index:5; display:none}
    #whoai{width:clamp(80px,10vw,120px); user-select:none; display:block}
    #accLayer{position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none}

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    #toast{position:fixed; right:10px; top:44px; z-index:20; background:rgba(255,255,255,.92);
      color:#111; padding:8px 12px; border-radius:10px; font-size:14px; min-width:180px}
  </style>
</head>
<body>
  <!-- èƒŒæ™¯ -->
  <div id="bg-night" class="bg show" aria-hidden="true"></div>

  <!-- Topbar -->
  <div id="topbar">
    <div class="left">
      <button class="btn" id="btnHome">Home</button>
      <button class="btn" id="btnAbout">ç ”ç©¶ã«ã¤ã„ã¦</button>
      <button class="btn" id="btnBeach">ç ‚æµœã¸</button>
      <button class="btn" id="btnChar">ã‚­ãƒ£ãƒ©å¤‰æ›´</button>
    </div>
    <div class="right">
      <span id="conn" class="pill" title="APIæ¥ç¶šçŠ¶æ…‹">checkingâ€¦</span>
      <button class="btn" id="btnLang">EN</button>
    </div>
  </div>

  <!-- whoaiï¼ˆå¤œã‚‚è¡¨ç¤ºï¼‰ -->
  <div id="whoaiWrap" aria-live="polite">
    <img id="whoai" src="" alt="whoai">
    <div id="accLayer" aria-hidden="true"></div>
  </div>

  <!-- ä¼šè©±ã‚«ãƒ¼ãƒ‰ -->
  <div id="wrap">
    <div id="panel" role="dialog" aria-labelledby="nightTitle">
      <div id="headerRow">
        <h2 id="nightTitle" style="margin:6px 0 0 6px">ã¾ãŸæ˜æ—¥</h2>
        <div id="personaRow">
          <span class="pill" id="personaLabel">ä¼šè©±ã‚­ãƒ£ãƒ©</span>
          <label><input type="radio" name="persona" value="random" checked>ãƒ©ãƒ³ãƒ€ãƒ </label>
          <label><input type="radio" name="persona" value="å…ƒæ°—">å…ƒæ°—</label>
          <label><input type="radio" name="persona" value="é™å¯‚">é™å¯‚</label>
          <label><input type="radio" name="persona" value="æƒ…ç†±">æƒ…ç†±</label>
          <label><input type="radio" name="persona" value="å‰µé€ ">å‰µé€ </label>
        </div>
      </div>

      <div id="nameRow">
        <input id="nameInput" type="text" maxlength="16" placeholder="ãªã¾ãˆï¼ˆä»»æ„ï¼‰">
        <button id="nameSave">ä¿å­˜</button>
        <span id="rareInfo" class="pill" title="é›†ã‚ãŸãƒ¬ã‚¢è²">ãƒ¬ã‚¢è² 0</span>
        <span id="displayName" class="pill" title="ç¾åœ¨ã®åå‰">â€•</span>
      </div>

      <div id="chatLog" aria-live="polite"></div>

      <div id="chatCtrl">
        <input id="chatInput" type="text" placeholder="å¤œç©ºã‚’è¦‹ãªãŒã‚‰ã€ä½•ã‚’è©±ãã†ï¼Ÿ">
        <button id="chatSend">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div id="toast">å¤œã®æµ·ã€‚è©±ãã†ã‹ï¼Ÿ</div>

  <!-- ä¼šè©±APIãƒ©ãƒƒãƒ‘ -->
  <script src="./web/talk.js"></script>

  <script>
  /* ===== util & store ===== */
  const $=(s,p=document)=>p.querySelector(s);
  const $$=(s,p=document)=>Array.from(p.querySelectorAll(s));
  const store={ get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}}, set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}} };
  const toast=$('#toast'); const say=(s)=>toast.textContent=s;

  /* ===== i18n ===== */
  const I18N={
    ja:{home:'Home',about:'ç ”ç©¶ã«ã¤ã„ã¦',beach:'ç ‚æµœã¸',char:'ã‚­ãƒ£ãƒ©å¤‰æ›´',langNext:'EN',
        title:'ã¾ãŸæ˜æ—¥', guide:'å¤œã®æµ·ã€‚è©±ãã†ã‹ï¼Ÿ', placeholder:'å¤œç©ºã‚’è¦‹ãªãŒã‚‰ã€ä½•ã‚’è©±ãã†ï¼Ÿ', send:'é€ä¿¡',
        persona:'ä¼šè©±ã‚­ãƒ£ãƒ©', random:'ãƒ©ãƒ³ãƒ€ãƒ ', namePH:'ãªã¾ãˆï¼ˆä»»æ„ï¼‰', save:'ä¿å­˜',
        rare:'ãƒ¬ã‚¢è²', nameNow:'ç¾åœ¨ã®åå‰', conn_ok:'APIæ¥ç¶šOK', conn_ng:'APIæœªæ¥ç¶šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å¿œç­”ï¼‰'
    },
    en:{home:'Home',about:'About',beach:'To Beach',char:'Change Char',langNext:'ä¸­æ–‡',
        title:'See you tomorrow', guide:'It\'s night by the sea. Shall we talk?', placeholder:'What shall we talk about under the night sky?', send:'Send',
        persona:'Persona', random:'Random', namePH:'Name (optional)', save:'Save',
        rare:'Rare shells', nameNow:'Current name', conn_ok:'API connected', conn_ng:'API offline (local reply)'
    },
    zh:{home:'é¦–é¡µ',about:'å…³äºç ”ç©¶',beach:'å»æµ·æ»©',char:'æ¢è§’è‰²',langNext:'í•œêµ­ì–´',
        title:'æ˜å¤©è§', guide:'å¤œæ™šçš„æµ·è¾¹ï¼Œæˆ‘ä»¬èŠèŠå§ï¼Ÿ', placeholder:'åœ¨æ˜Ÿç©ºä¸‹èŠäº›ä»€ä¹ˆï¼Ÿ', send:'å‘é€',
        persona:'ä¼šè¯è§’è‰²', random:'éšæœº', namePH:'åå­—ï¼ˆå¯é€‰ï¼‰', save:'ä¿å­˜',
        rare:'ç¨€æœ‰è´å£³', nameNow:'å½“å‰åç§°', conn_ok:'APIå·²è¿æ¥', conn_ng:'APIæœªè¿æ¥ï¼ˆæœ¬åœ°å›å¤ï¼‰'
    },
    ko:{home:'í™ˆ',about:'ì—°êµ¬ ì†Œê°œ',beach:'í•´ë³€ìœ¼ë¡œ',char:'ìºë¦­í„° ë³€ê²½',langNext:'æ—¥æœ¬èª',
        title:'ë‚´ì¼ ë˜ ë´ìš”', guide:'ë°¤ë°”ë‹¤ì…ë‹ˆë‹¤. ì´ì•¼ê¸°í•´ë³¼ê¹Œìš”?', placeholder:'ë°¤í•˜ëŠ˜ì„ ë³´ë©° ë¬´ì—‡ì„ ì´ì•¼ê¸°í• ê¹Œìš”?', send:'ë³´ë‚´ê¸°',
        persona:'í˜ë¥´ì†Œë‚˜', random:'ëœë¤', namePH:'ì´ë¦„(ì„ íƒ)', save:'ì €ì¥',
        rare:'ë ˆì–´ ì¡°ê°œ', nameNow:'í˜„ì¬ ì´ë¦„', conn_ok:'API ì—°ê²°ë¨', conn_ng:'API ë¯¸ì—°ê²°(ë¡œì»¬ ì‘ë‹µ)'
    }
  };
  const LANG_ORDER=['ja','en','zh','ko'];
  const LANG_LABEL={ja:'æ—¥æœ¬èª',en:'EN',zh:'ä¸­æ–‡',ko:'í•œêµ­èª'};
  const getLang=()=>localStorage.getItem('who_vq.lang')||'ja';
  function setLang(lang){
    const L=I18N[lang]||I18N.ja;
    document.documentElement.setAttribute('lang',lang);
    localStorage.setItem('who_vq.lang',lang);
    $('#btnHome').textContent=L.home; $('#btnAbout').textContent=L.about; $('#btnBeach').textContent=L.beach; $('#btnChar').textContent=L.char;
    $('#btnLang').textContent=LANG_LABEL[LANG_ORDER[(LANG_ORDER.indexOf(lang)+1)%LANG_ORDER.length]];
    $('#btnLang').title=`è¨€èªã‚’${$('#btnLang').textContent}ã«åˆ‡ã‚Šæ›¿ãˆ`;
    $('#nightTitle').textContent=L.title; $('#chatInput').placeholder=L.placeholder; $('#chatSend').textContent=L.send;
    $('#personaLabel').textContent=L.persona; $$('label[for]').forEach(()=>{}); // no-op
    $('label input[value="random"]').parentElement.lastChild.nodeValue=L.random;
    $('#nameInput').placeholder=L.namePH; $('#nameSave').textContent=L.save;
    $('#rareInfo').title=L.rare; $('#displayName').title=L.nameNow;
    say(L.guide);
  }
  function toggleLang(){ const cur=getLang(); const i=LANG_ORDER.indexOf(cur); setLang(LANG_ORDER[(i+1)%LANG_ORDER.length]); }

  /* ===== character restore / redirect ===== */
  const whoaiWrap=$('#whoaiWrap'), whoai=$('#whoai'), accLayer=$('#accLayer');
  const savedChar=store.get('who_vq.char',null);
  if(!savedChar){ location.href='./char.html'; }
  else { whoai.src=savedChar; whoaiWrap.style.display='block'; }

  /* ===== name & rare count ===== */
  const nameInput=$('#nameInput'), nameSave=$('#nameSave'), rareInfo=$('#rareInfo'), dispName=$('#displayName');
  function getCollection(){return store.get('who_vq.collection',{});}
  function rareCount(){
    const RARE=['aurora_shell','rare_pearl','rare_rainbow'];
    const col=getCollection(); return RARE.reduce((s,k)=>s+(col[k]||0),0);
  }
  function refreshNameBar(){
    rareInfo.textContent = (I18N[getLang()]||I18N.ja).rare+' '+rareCount();
    const cur=store.get('who_vq.displayName','')||'â€•'; dispName.textContent=cur;
  }
  nameSave.onclick=()=>{
    const nm=(nameInput.value||'').trim();
    if(!nm){ store.set('who_vq.displayName',''); refreshNameBar(); return; }
    // ãƒ¬ã‚¢è²2å€‹ã§å‘½åOKï¼ˆä¾‹ï¼‰
    if(rareCount()<2){ alert('ãƒ¬ã‚¢è²ãŒ2å€‹å¿…è¦ã§ã™'); return; }
    store.set('who_vq.displayName', nm); refreshNameBar();
  };

  /* ===== persona ===== */
  function currentPersona(){
    const r=document.querySelector('input[name="persona"]:checked');
    return r ? r.value : 'random';
  }

  /* ===== acc restore (è¦‹ãŸç›®ã ã‘) ===== */
  const ACCESSORIES=[ {key:'straw_hat',src:'./public/accessories/straw_hat.png',cls:'straw_hat'},
                      {key:'knit_hat',src:'./public/accessories/knit_hat.png',cls:'knit_hat'},
                      {key:'sunglasses',src:'./public/accessories/sunglasses.png',cls:'sunglasses'},
                      {key:'ribbon_yellow',src:'./public/accessories/ribbon_yellow.png',cls:'ribbon_yellow'},
                      {key:'star_yellow',src:'./public/accessories/star_yellow.png',cls:'star_yellow'} ];
  function getActiveAcc(){ return new Set(store.get('who_vq.accessories',[])); }
  function addAccImg(a){ const old=accLayer.querySelector(`.acc[data-key="${a.key}"]`); if(old) old.remove(); const img=document.createElement('img'); img.src=a.src; img.className='acc '+(a.cls||''); img.dataset.key=a.key; accLayer.appendChild(img); }
  function restoreAccessories(){ const act=getActiveAcc(); ACCESSORIES.forEach(a=>{ if(act.has(a.key)) addAccImg(a); }); }

  /* ===== chat ===== */
  const chatLog=$('#chatLog'), chatInput=$('#chatInput'), chatSend=$('#chatSend'), conn=$('#conn');
  function addMsg(role,text){ const d=document.createElement('div'); d.className='msg '+(role==='user'?'me':'ai'); d.textContent=text; chatLog.appendChild(d); chatLog.scrollTop=chatLog.scrollHeight; }

  async function checkConn(){
    // å˜ç´”ãªå­˜åœ¨ç¢ºèªï¼ˆtalk.jsãŒã‚ã‚Šã€é–¢æ•°ãŒã‚ã‚Œã°OKæ‰±ã„ï¼‰
    const ok = !!(window.WHOAI_TALK && typeof WHOAI_TALK.talk==='function');
    const L=I18N[getLang()]||I18N.ja;
    conn.textContent = ok ? L.conn_ok : L.conn_ng;
    conn.style.background = ok ? 'rgba(76,175,239,.2)' : 'rgba(255,255,255,.18)';
    conn.style.borderColor = ok ? 'rgba(76,175,239,.7)' : 'rgba(255,255,255,.3)';
    return ok;
  }

  async function sendChat(){
    const text=(chatInput.value||'').trim(); if(!text) return;
    addMsg('user', text); chatInput.value='';
    const L=I18N[getLang()]||I18N.ja;
    const payload={ state:{ totalCollected: store.get('who_vq.count',0)||0,
                            displayName: store.get('who_vq.displayName','')||'',
                            persona: currentPersona() } };
    try{
      if(await checkConn()){
        const {reply} = await WHOAI_TALK.talk(text, payload);
        addMsg('ai', reply || 'â€¦');
      }else{
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const persona=payload.state.persona;
        const flair = (persona==='å…ƒæ°—'?'ğŸ”¥':persona==='é™å¯‚'?'ğŸŒ™':persona==='æƒ…ç†±'?'ğŸ’«':persona==='å‰µé€ '?'ğŸŒ€':'âœ¨');
        addMsg('ai', `${flair} ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰${text}ã€‚æ³¢éŸ³ãŒå¿ƒåœ°ã„ã„ã­ã€‚`);
      }
    }catch(e){
      addMsg('ai','ï¼ˆæ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰'); console.error(e);
    }
  }

  chatSend.onclick = sendChat;
  chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });

  /* ===== routing ===== */
  $('#btnHome').onclick = ()=>location.href='./index.html';
  $('#btnAbout').onclick= ()=>location.href='./about.html';
  $('#btnBeach').onclick = ()=>{ store.set('who_vq.lastScene','beach'); location.href='./beach.html'; };
  $('#btnChar').onclick  = ()=>location.href='./char.html';
  $('#btnLang').onclick  = ()=>{ toggleLang(); checkConn(); };

  /* ===== init ===== */
  function init(){
    setLang(getLang());
    $('#bg-night').classList.add('show');
    restoreAccessories();
    refreshNameBar();
    // åˆå›ã®ä¸€è¨€
    const greeted = sessionStorage.getItem('who_vq.nightGreeted');
    if(!greeted){ addMsg('ai', (I18N[getLang()]||I18N.ja).guide); sessionStorage.setItem('who_vq.nightGreeted','1'); }
    whoaiWrap.style.display='block';
    checkConn();
    store.set('who_vq.lastScene','night');
  }
  init();
  </script>
</body>
</html>
