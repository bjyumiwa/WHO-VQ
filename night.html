<!DOCTYPE html>
</div>
</main>


<script>
window.addEventListener('DOMContentLoaded', () => {
initLang();
localStorage.setItem('who_lastPage','night.html');
const log = document.getElementById('chatLog');
const input = document.getElementById('msg');
const send = document.getElementById('send');
const summary = document.getElementById('summary');
const chips = document.getElementById('chips');


// 今日の集計を表示
const s = JSON.parse(localStorage.getItem('who_shells_summary')||'null');
if(s && s.counts){
const map = s.counts; const names = {asari:getText('shell_asari'), hamaguri:getText('shell_hama'), pearl:getText('shell_pearl'), rare:getText('shell_rare')};
const line = Object.entries(names).map(([k,v])=>`${v}×${map[k]||0}`).join(' / ');
summary.textContent = `${getText('score')}: ${s.score} ｜ ${line}`;
// 哲学的な問いのチップ
const prompts = [
getText('p1'), // なぜ助けた？
getText('p2'), // どんな喜び？
getText('p3'), // 関わりは誰のため？
];
chips.innerHTML = '';
for(const p of prompts){
const b = document.createElement('button'); b.className='chip'; b.textContent = p; b.onclick = ()=>{ input.value = p + ' '; input.focus(); };
chips.appendChild(b);
}
} else {
summary.textContent = getText('no_summary');
}


function push(role, text){
const div = document.createElement('div');
div.className = 'bubble ' + role;
div.textContent = text;
log.appendChild(div); log.scrollTop = log.scrollHeight;
}


async function go(){
const m = input.value.trim(); if(!m) return;
push('user', m); input.value=''; input.focus();
try{
const res = await talkAPI({message: decorate(m)});
push('bot', res.reply || getText('empty_reply'));
}catch(e){ toast(getText('api_error')); }
}


function decorate(m){
// 直近の集計を文頭に付与（API側で文脈利用可能）
const s = JSON.parse(localStorage.getItem('who_shells_summary')||'null');
if(!s||!s.counts) return m;
const names = {asari:getText('shell_asari'), hamaguri:getText('shell_hama'), pearl:getText('shell_pearl'), rare:getText('shell_rare')};
const line = Object.entries(names).map(([k,v])=>`${v}:${(s.counts[k]||0)}`).join(', ');
return `[today shells score=${s.score}; ${line}]\n` + m;
}


send.onclick = go;
input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ go(); }});
});
</script>
</body>
</html>
